amends "shared/PklCI.pkl"

import "shared/base.pkl"

testReports {
  junit {
    "build/test-results/**/*.xml"
  }
}

build {
  jobs {
    ["build-and-test"] = (base.buildAndTest) {
      name = "Build and test"
    }
  }
}

// run same workflow as `build`
prb = build

release {
  jobs {
    ["publish"] = (base.buildAndTest) {
      name = "Release"
      permissions {
        contents = "write"
      }
      steps {
        new {
          name = "Run gradle publish"
          run = "./gradlew -DreleaseBuild=true publish"
        }
        new {
          name = "Create GitHub release"
          env {
            ["GH_TOKEN"] = "${{ github.token }}"
            ["TAG_NAME"] = "${{ github.ref_name }}"
          }
          // language=bash
          run = #"""
            echo "Preparing updatePlugins.xml"
            sed -i -e 's/#version#/'${TAG_NAME}'/g' release/updatePlugins.xml

            echo "Creating release"
            gh release create ${TAG_NAME} \
              --title "${TAG_NAME}" \
              --target "${{ github.sha }}" \
              --verify-tag \
              --notes "Release notes: https://pkl-lang.org/intellij/current/changelog.html#release-${TAG_NAME}" \
              --repo "${{ github.repository }}" \
              release/*.*
            """#
        }
      }
    }
  }
}
